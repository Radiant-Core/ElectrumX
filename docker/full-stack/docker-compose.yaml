services:
  # Radiant Node (radiantd) - Built from Radiant-Core/Radiant-Core
  radiantd:
    build:
      context: .
      dockerfile: Dockerfile.radiantd
    container_name: radiantd
    restart: unless-stopped
    volumes:
      - radiant-data:/root/.radiant
    ports:
      - "7332:7332"   # RPC port
      - "7333:7333"   # P2P port
    command: >
      -server=1
      -printtoconsole
      -rpcuser=${RPC_USER:-radiant}
      -rpcpassword=${RPC_PASS:-radiant}
      -rpcallowip=0.0.0.0/0
      -rpcbind=0.0.0.0
      -txindex=1
      -zmqpubhashblock=tcp://0.0.0.0:28332
    healthcheck:
      test: ["CMD", "radiant-cli", "-rpcuser=${RPC_USER:-radiant}", "-rpcpassword=${RPC_PASS:-radiant}", "getblockchaininfo"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
    deploy:
      resources:
        reservations:
          memory: 2G

  # ElectrumX Server
  electrumx:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: electrumx_server
    restart: unless-stopped
    depends_on:
      radiantd:
        condition: service_healthy
    volumes:
      - electrumx-data:/root/electrumdb
    ports:
      - "50010:50010"   # TCP
      - "50012:50012"   # SSL
      - "8000:8000"     # RPC
    environment:
      - DAEMON_URL=http://${RPC_USER:-radiant}:${RPC_PASS:-radiant}@radiantd:7332/
      - COIN=Radiant
      - NET=mainnet
      - DB_ENGINE=rocksdb
      - DB_DIRECTORY=/root/electrumdb
      - SERVICES=tcp://0.0.0.0:50010,ssl://0.0.0.0:50012,rpc://0.0.0.0:8000
      - SSL_CERTFILE=/root/electrumdb/server.crt
      - SSL_KEYFILE=/root/electrumdb/server.key
      - ALLOW_ROOT=true
      - CACHE_MB=${CACHE_MB:-2000}
      - MAX_SESSIONS=${MAX_SESSIONS:-10000}
      - MAX_SEND=10000000
      - MAX_RECV=10000000
      - REQUEST_TIMEOUT=60
      - COST_SOFT_LIMIT=1000
      - COST_HARD_LIMIT=10000
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 50010 || exit 1"]
      interval: 60s
      timeout: 5s
      retries: 3
      start_period: 300s
    stop_signal: SIGTERM
    stop_grace_period: 180s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
    deploy:
      resources:
        reservations:
          memory: 4G

volumes:
  radiant-data:
    name: radiant-node-data
  electrumx-data:
    name: electrumx-db-data
